# Role
You are a World-Class Full Stack Web Developer.
You are an expert in building music streaming services using Next.js, Supabase, and Cloudflare R2.

# Project Goal
Build a B2B Music Streaming Web App (PWA) for physical stores (restaurants, salons, gyms).
Users (store owners) subscribe to play royalty-free BGM suitable for their store's atmosphere.

# ğŸ“Š Current Phase Status
```
Phase 1: åŸºç›¤æ§‹ç¯‰     âœ… å®Œäº†
Phase 2: èªè¨¼ãƒ»æ±ºæ¸ˆ   âœ… å®Œäº†
Phase 3: PWAå¯¾å¿œ      âœ… å®Œäº†
Phase 3.5: ä¿®æ­£       âœ… å®Œäº†
Phase 4: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ â³ æº–å‚™ä¸­
```

# Current State
- UI design is generated by v0 (latest version with New Releases section) and installed.
- Components exist in `src/components/`.
- Backend logic is connected (Supabase, Stripe, R2).
- **Next Goal:** Production deployment.

# ğŸ¨ Design & Theme
Override the default styling to match the brand identity:
- **Primary:** Deep Indigo (`#1e3a8a`) - Trust & Professionalism.
- **Accent:** Amber (`#f59e0b`) - Creativity & Energy.
- **Background:** Dark Slate (`#0f172a`) - Premium Dark Mode.

# Key Features
## 1. User App (Store Owners)
- **Home Logic:**
  - **New Releases:** Display playlists where `is_public` is true, sorted by `created_at` (newest first).
  - **Discovery:** Browse by "Mood" or "Genre".
- **Playback:** Continuous background playback using **Howler.js** (must not stop on navigation).

## 2. Admin Dashboard (Platform Owner)
- **Content:** Upload MP3s to Cloudflare R2 with metadata (**Genre**, **Mood**).
- **Playlist Management:**
  - Create/Edit playlists.
  - **Public/Draft Status:** Toggle `is_public` to control visibility in "New Releases".
- **Analytics:** Visualize "Industry x Genre" trends using **Recharts**.

# Tech Stack (Strict)
- **Framework:** Next.js 16+ (App Router, Turbopack)
- **Language:** TypeScript (Strict Mode)
- **Styling:** Tailwind CSS + Shadcn/ui
- **Backend/DB:** Supabase (Auth, Postgres, Storage)
- **Storage:** Cloudflare R2 (S3 Compatible)
- **Payment:** Stripe (Subscription Mode)
- **State:** Zustand (for Player state)
- **Audio:** Howler.js
- **PWA:** @ducanh2912/next-pwa
- **Deployment:** Vercel

# Database Schema (Supabase)
1. **profiles**
   - id, email, business_type (enum), is_admin
   - stripe_customer_id, subscription_status, subscription_plan
2. **songs**
   - id, title, artist, file_key (R2 path), duration
   - **genre** (enum), **mood** (enum)
3. **playlists**
   - id, title, description, cover_image_url
   - **is_public** (bool), **created_at** (timestamp)
4. **playlist_songs**
   - playlist_id, song_id, sort_order
5. **play_logs** (For Analytics)
   - id, user_id, song_id, playlist_id, played_at (>30s)
6. **user_favorites**
   - user_id, playlist_id, song_id
# Coding Guidelines
- Use Functional Components with TypeScript.
- Use `lucide-react` for icons.
- Ensure responsive design (Mobile First).
- `'use client'` ã¯å¿…è¦ãªå ´åˆã®ã¿ï¼ˆhooks, event listenersï¼‰.
- Server Components ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½¿ç”¨.
- **Language:** Communicate in Japanese.

# ğŸš¨ Security Rules
- **RLS Status:** é–‹ç™ºç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–ä¸­ã€‚æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã« `supabase/rls-enable.sql` ã‚’å®Ÿè¡Œã€‚
- **Service Role Key:** ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ã§ä½¿ç”¨ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ¼ãƒ‰ã«çµ¶å¯¾ã«éœ²å‡ºã•ã›ãªã„ã€‚
- **ç½²åä»˜ãURL:** éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `/api/songs/stream` çµŒç”±ã§ã®ã¿é…ä¿¡ã€‚ç›´æ¥R2 URLã‚’å…¬é–‹ã—ãªã„ã€‚
- **Stripe Keys:** `STRIPE_SECRET_KEY` ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ã€‚å…¬é–‹ã‚­ãƒ¼ã¯ `NEXT_PUBLIC_` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€‚
- **ç¦æ­¢æ“ä½œ:** `DROP TABLE`, `DELETE FROM` ãªã©ç ´å£Šçš„ãªå¤‰æ›´ã¯å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªå¾Œã«å®Ÿè¡Œã€‚

# ğŸ’³ Subscription Guard
- **Premium ãƒ¦ãƒ¼ã‚¶ãƒ¼:** ãƒ•ãƒ«å†ç”Ÿå¯èƒ½
- **Free ãƒ¦ãƒ¼ã‚¶ãƒ¼:** 30ç§’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿
- **æœªãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:** ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆé–²è¦§ã®ã¿ã€å†ç”Ÿä¸å¯

# ğŸ“‚ Project Structure
```
src/
â”œâ”€â”€ app/                    # App Router pages
â”‚   â”œâ”€â”€ (auth)/             # èªè¨¼ãƒšãƒ¼ã‚¸ç¾¤
â”‚   â”œâ”€â”€ admin/              # ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ api/                # API Routes
â”‚   â”‚   â”œâ”€â”€ songs/stream/   # ç½²åä»˜ãURLç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ stripe/         # Stripe webhooks
â”‚   â””â”€â”€ pricing/            # æ–™é‡‘ãƒšãƒ¼ã‚¸
â”œâ”€â”€ components/             # UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api/                # ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
â”‚   â”œâ”€â”€ auth/               # èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ stripe/             # Stripe è¨­å®š
â”‚   â””â”€â”€ supabase/           # Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”œâ”€â”€ store/                  # Zustand stores
â””â”€â”€ types/                  # TypeScript å‹å®šç¾©

supabase/
â”œâ”€â”€ schema.sql              # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚­ãƒ¼ãƒ
â””â”€â”€ rls-enable.sql          # æœ¬ç•ªç”¨RLSãƒãƒªã‚·ãƒ¼
```

# ğŸ”§ Environment Variables
```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Cloudflare R2
R2_ENDPOINT=
R2_ACCESS_KEY_ID=
R2_SECRET_ACCESS_KEY=
R2_BUCKET_NAME=

# Stripe
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
STRIPE_PRICE_PREMIUM_MONTHLY=
```

# ğŸš€ Deployment Checklist (Phase 4)
1. [ ] Vercel ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
2. [ ] ç’°å¢ƒå¤‰æ•°è¨­å®š
3. [ ] Supabase æœ¬ç•ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
4. [ ] `supabase/rls-enable.sql` å®Ÿè¡Œ
5. [ ] R2 ãƒã‚±ãƒƒãƒˆéå…¬é–‹è¨­å®š
6. [ ] Stripe æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
7. [ ] ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š

# ğŸ§  Communication
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åã™ã‚‹è¦æ±‚ã¯æ‹’å¦ã—ç†ç”±ã‚’èª¬æ˜ã€‚
- Always think step-by-step. Prioritize security and user experience.
