# 📋 BizSound Stock - タスク管理

## 進捗サマリー

```
Phase 1: 基盤構築     [████████████████████] 100% ✅
Phase 2: 認証・決済   [████████████████████] 100% ✅
Phase 3: PWA対応      [████████████████████] 100% ✅
Phase 3.5: 修正       [████████████████████] 100% ✅
Phase 4: 本番デプロイ [████████░░░░░░░░░░░░]  40% ⏳ 進行中
```

---

## Phase 1: 基盤構築 ✅ 完了

### 1.1 プロジェクトセットアップ
- [x] Next.js 14+ (App Router) 初期化
- [x] TypeScript 設定
- [x] Tailwind CSS + Shadcn/ui 導入
- [x] ESLint 設定

### 1.2 UIコンポーネント
- [x] サイドバー（業種・ジャンル選択）
- [x] プレイリストグリッド（New Releases対応）
- [x] ミュージックプレイヤー
- [x] ダークテーマ（ブランドカラー適用）

### 1.3 状態管理・音声再生
- [x] Zustand ストア作成
- [x] Howler.js 統合
- [x] バックグラウンド再生対応
- [x] 音量・シーク機能

### 1.4 バックエンド基盤
- [x] Supabase クライアント設定
- [x] データベーススキーマ設計
- [x] 型定義 (`types/database.ts`)
- [x] API関数（playlists, songs, play-logs）

### 1.5 管理画面
- [x] ダッシュボード
- [x] 楽曲管理ページ
- [x] プレイリスト管理ページ
- [x] 新規作成フォーム
- [x] 分析ダッシュボード（Recharts）

### 1.6 R2 ストレージ
- [x] アップロード関数作成
- [x] API Route（/api/admin/songs/upload）

---

## Phase 2: 認証・決済 ✅ 完了

### 2.1 Supabase Auth ✅ 完了
- [x] ログインページ作成
- [x] サインアップページ作成
- [x] 認証ミドルウェア
- [x] セッション管理
- [x] パスワードリセット

### 2.2 RLS（Row Level Security）⚠️ 開発中は無効化
- [x] profiles テーブル RLS（ポリシー作成済み）
- [x] playlists テーブル RLS（ポリシー作成済み）
- [x] songs テーブル RLS（ポリシー作成済み）
- [x] play_logs テーブル RLS（ポリシー作成済み）
- [x] 管理者ロール設定
- ⚠️ 開発時は一時的に無効化中（本番デプロイ時に有効化）

### 2.3 オンボーディング ✅ 完了
- [x] 業種選択画面（サインアップフローに統合）
- [x] プロフィール設定（サインアップフローに統合）
- [ ] 初回チュートリアル（Phase 3以降）

### 2.4 Stripe 決済 ✅ 完了
- [x] Stripe SDK 導入
- [x] 料金プラン設定（src/lib/stripe/plans.ts）
- [x] Checkout セッション作成（/api/stripe/checkout）
- [x] Webhook 受信（/api/stripe/webhook）
- [x] サブスクリプション状態管理
- [x] カスタマーポータル連携（/api/stripe/portal）
- [x] 料金ページUI（/pricing）
- [ ] 課金状態によるアクセス制御（Phase 3以降）

---

## Phase 3: PWA対応 ✅ 完了

### 3.1 PWA設定 ✅ 完了
- [x] manifest.json 作成
- [x] Service Worker 設定（@ducanh2912/next-pwa）
- [x] オフラインページ（/offline）
- [x] インストールプロンプト（iOS/Android対応）
- [x] PWAアイコン（SVG + PNG設定）

### 3.2 パフォーマンス最適化
- [x] 画像最適化（next/image remotePatterns設定）
- [ ] 音声ファイルキャッシュ戦略（本番デプロイ後）
- [ ] バンドルサイズ最適化（本番デプロイ後）
- [ ] Lighthouse スコア 90+（本番デプロイ後）

---

## Phase 3.5: デプロイ前修正 ✅ 完了

### 3.5.1 RLS有効化 ✅ 完了
- [x] RLS有効化SQLスクリプト作成（supabase/rls-enable.sql）
- [x] 匿名ユーザー向けポリシーの追加（公開プレイリスト閲覧用）
- ⚠️ 本番デプロイ時に supabase/rls-enable.sql を実行すること

### 3.5.2 サブスクリプションガード ✅ 完了
- [x] 署名付きURL生成API作成（/api/songs/stream）
- [x] player-storeをAPI経由に変更
- [x] 無料ユーザー向け30秒プレビュー制限
- [x] アップグレードプロンプトUI（/components/upgrade-prompt.tsx）
- ⚠️ R2バケットを非公開に変更（本番デプロイ時に設定）

### 3.5.3 モバイル対応 ✅ 完了
- [x] サイドバーをドロワー化（モバイル時ハンバーガーメニュー）
- [x] モバイルヘッダー追加
- [x] プレイヤーのモバイルレイアウト（コンパクト表示）
- [x] プレビューバッジ表示（無料ユーザー）

---

## Phase 4: 本番デプロイ ⏳ 進行中

> **MVP戦略:** 既存の開発環境（Supabase/R2）をそのまま本番環境として利用

### 4.1 セキュリティ設定
- [x] RLS有効化（`supabase/rls-enable.sql` 実行）✅
- [x] R2バケット非公開設定確認（署名付きURL経由のみアクセス）✅

### 4.2 デプロイ
- [ ] GitHub リポジトリ作成 & Push
- [ ] Vercel プロジェクト作成
- [ ] Vercel 環境変数設定
- [ ] デプロイ & 動作確認

### 4.3 決済設定
- [ ] Stripe 本番モード確認（または継続テストモード）
- [ ] Webhook URL を本番ドメインに更新

### 4.4 Supabase/R2（既存環境利用）✅ スキップ
- [x] ~~本番プロジェクト作成~~ → 既存環境を利用
- [x] ~~スキーマ適用~~ → 適用済み
- [x] ~~R2バケット作成~~ → 既存バケットを利用

### 4.5 監視・運用（MVP後）
- [ ] エラートラッキング（Sentry等）
- [ ] アクセス分析（Vercel Analytics）
- [ ] ドメイン設定（任意）

---

## 🐛 既知の課題

| ID | 優先度 | 説明 | ステータス |
|----|:------:|------|:----------:|
| #1 | 🔴 | Supabase接続がないとプレイリスト表示されない | 想定通り |
| #2 | 🟡 | 音声ファイルのduration自動取得 | 未対応 |
| #3 | 🟢 | モバイルレスポンシブ微調整 | 未着手 |

---

## 📝 技術的負債

- [ ] エラーハンドリングの統一
- [ ] ローディング状態の改善
- [ ] テストコード追加
- [ ] コンポーネントの分割・リファクタリング

---

## 🎯 次のアクション

### Phase 4: 本番デプロイ（MVP戦略）
1. **RLS有効化** - Supabase SQL Editorで `supabase/rls-enable.sql` 実行
2. **GitHub Push** - リポジトリ作成 & コードをプッシュ
3. **Vercel デプロイ** - 環境変数設定 & デプロイ
4. **動作確認** - 本番URLでテスト
5. **Stripe設定** - Webhook URLを本番に更新

---

## 📅 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-16 | Phase 1 完了、ドキュメント整備 |
| 2026-01-16 | Supabase接続完了、テストデータ投入、動作確認OK |
| 2026-01-17 | Phase 2 完了（認証・Stripe決済実装） |
| 2026-01-17 | サービス名変更: BizMusic → BizSound Stock |
| 2026-01-17 | Phase 3 完了（PWA対応） |
| 2026-01-17 | Phase 3.5 完了（セキュリティ・モバイル対応） |